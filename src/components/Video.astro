---
export interface Props {
  width: number;
  stream?: MediaStream;
}

const { width } = Astro.props;
---

<video id="localVideo" playsinline autoplay controls="false" width={width}
></video>
<script>
  async function playVideo(elem: HTMLSelectElement) {
    const constraints = {
      // audio: { echoCancellation: true },
      video: {
        deviceId: elem.value,
        // width: { min: minWidth },
        // height: { min: minHeight },
      },
    };

    try {
      const stream = await navigator.mediaDevices.getUserMedia(constraints);
      const videoElement = document.querySelector(
        "video#localVideo"
      ) as HTMLVideoElement | null;

      if (videoElement != null) {
        if (videoElement.srcObject == null) {
          videoElement.srcObject = stream;
        } else {
          videoElement.srcObject = null;
          videoElement.srcObject = stream;
        }
      }
    } catch (error) {
      console.error("Error opening video camera.", error);
    }
  }

  const selectElement = document.querySelector(
    "select#availableCameras"
  ) as HTMLSelectElement | null;

  if (selectElement == null) {
    console.error("No video element found.");
  } else {
    await playVideo(selectElement);
    selectElement.addEventListener("change", (event) => {
      playVideo(selectElement).then();
    });
  }
</script>
